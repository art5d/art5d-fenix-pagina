<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #FF5A5F;
      --color-secondary: #007A87;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f9fb;
    }
    .slot-bar-ia {
      background-color: var(--color-primary);
    }
    .slot-bar-propio {
      background-color: var(--color-secondary);
    }
    .btn-primary {
      background-color: var(--color-primary);
      transition: all 0.2s;
    }
    .btn-primary:hover {
      background-color: #e54c50;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(255, 90, 95, 0.4);
    }
    .card {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    /* Estilo para el icono de carga */
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

  <div id="app" class="max-w-4xl mx-auto">

    <!-- Encabezado y Título -->
    <header class="mb-8">
      <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
        <svg class="w-8 h-8 mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.414L14.586 5A2 2 0 0115 6.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
        Panel de Artista FÉNIX v5.0
      </h1>
      <p class="text-gray-500 mt-1">Gestión de Slots, Certificación y Bocetos IA.</p>
    </header>

    <!-- Sección de Alerta y Estado General -->
    <div id="general-status" class="mb-6 card p-4 rounded-xl bg-white hidden">
      <!-- El contenido de estado se inyectará aquí -->
    </div>

    <!-- Contenedor Principal (Flex en desktop, Bloque en móvil) -->
    <div class="lg:flex lg:space-x-8">

      <!-- Columna Izquierda: Obra Propia (Flujo 3) -->
      <section class="lg:w-1/2 mb-8 lg:mb-0 card p-6 rounded-xl bg-white border border-gray-100">
        <h2 class="text-xl font-bold mb-4 text-color-secondary">Flujo 3: Certificar Obra Propia</h2>
        <p class="text-sm text-gray-500 mb-4">Sube tu obra de arte digital para ser certificada en la Galería VR. Tienes <span id="slots-propio-disp" class="font-bold text-color-secondary">0</span> slots disponibles de 10.</p>

        <div id="upload-form">
          <label class="block mb-2 text-sm font-medium text-gray-900">Selecciona tu Obra (PNG/JPG, máx 5MB)</label>
          <input type="file" id="file-input" accept="image/png, image/jpeg" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 p-3" required>
          <button id="upload-button" onclick="handleUploadOwnWork()" class="btn-primary w-full text-white font-semibold py-3 px-4 rounded-lg mt-4 disabled:opacity-50" disabled>
            Subir y Certificar Obra
          </button>
        </div>
        
        <!-- Contenedor para la imagen previsualizada (opcional) -->
        <div id="preview-container" class="mt-4 hidden">
          <p class="text-xs text-gray-500 mb-2">Previsualización de la Obra:</p>
          <img id="image-preview" class="w-full h-auto rounded-lg border border-gray-200 object-cover max-h-64" alt="Vista previa de la obra a subir">
        </div>
      </section>

      <!-- Columna Derecha: Boceto IA (Flujo 4) -->
      <section class="lg:w-1/2 card p-6 rounded-xl bg-white border border-gray-100">
        <h2 class="text-xl font-bold mb-4 text-color-primary">Flujo 4: Generar Boceto IA</h2>
        <p class="text-sm text-gray-500 mb-4">Genera un boceto conceptual usando Gemini (IA). Tienes <span id="slots-ia-disp" class="font-bold text-color-primary">0</span> slots disponibles de 5.</p>

        <div id="ia-form">
          <label for="ia-prompt" class="block mb-2 text-sm font-medium text-gray-900">Prompt / Descripción (Máx 250 caracteres)</label>
          <textarea id="ia-prompt" rows="4" maxlength="250" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-red-500 focus:border-red-500" placeholder="Describe tu obra futurista..."></textarea>
          <button id="ia-button" onclick="handleGenerateIA()" class="btn-primary w-full text-white font-semibold py-3 px-4 rounded-lg mt-4 disabled:opacity-50" disabled>
            Generar Boceto IA y Consumir Slot
          </button>
        </div>

        <!-- Resultados de la IA -->
        <div id="ia-result-container" class="mt-6 border-t border-gray-100 pt-4 hidden">
          <p class="text-sm font-semibold mb-2">Resultado del Boceto IA:</p>
          <div id="ia-message" class="text-green-600 text-sm mb-2"></div>
          <img id="ia-image-preview" class="w-full h-auto rounded-lg border border-gray-200 object-cover max-h-64" alt="Boceto IA generado">
        </div>
      </section>
    </div>
    
    <!-- Contenedor para Modales/Mensajes -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 p-4 items-center justify-center">
      <div class="bg-white p-6 rounded-xl w-full max-w-md card">
        <h3 id="modal-title" class="text-xl font-bold mb-3">Título</h3>
        <p id="modal-message" class="text-gray-700 mb-4"></p>
        <div id="modal-details" class="text-sm p-3 bg-gray-50 rounded-lg mb-4 hidden"></div>
        <button onclick="hideModal()" class="btn-primary px-4 py-2 text-white font-semibold rounded-lg w-full">Cerrar</button>
      </div>
    </div>

  </div>

  <script>
    // Variables globales
    let slotsState = null;
    let currentUserId = 'ARTIST_12345'; // ID de prueba, cambiar para probar otros casos en codigo.gs

    // =========================================================
    // UTILIDADES DE UI
    // =========================================================

    /** Muestra un modal de mensaje (reemplaza alert/confirm) */
    function showModal(title, message, details = null) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-message').innerHTML = message;
      const detailsDiv = document.getElementById('modal-details');
      if (details) {
        detailsDiv.innerHTML = details;
        detailsDiv.classList.remove('hidden');
      } else {
        detailsDiv.classList.add('hidden');
      }
      document.getElementById('message-modal').classList.remove('hidden');
      document.getElementById('message-modal').classList.add('flex');
    }

    /** Oculta el modal de mensaje */
    function hideModal() {
      document.getElementById('message-modal').classList.add('hidden');
      document.getElementById('message-modal').classList.remove('flex');
    }
    
    /** Habilita/Deshabilita botones de interacción */
    function setButtonLoading(buttonId, isLoading, originalText) {
      const button = document.getElementById(buttonId);
      if (isLoading) {
        button.setAttribute('data-original-text', originalText);
        button.innerHTML = '<span class="spinner"></span> Procesando...';
        button.disabled = true;
      } else {
        button.innerHTML = button.getAttribute('data-original-text') || originalText;
        button.disabled = false;
        button.removeAttribute('data-original-text');
      }
    }

    // =========================================================
    // LÓGICA DE SLOTS Y ESTADO
    // =========================================================

    /** Muestra el estado general del pack. */
    function renderGeneralStatus() {
      const statusDiv = document.getElementById('general-status');
      if (!slotsState || !slotsState.isPackActive) {
        statusDiv.classList.remove('hidden');
        statusDiv.classList.add('bg-yellow-100', 'border-yellow-200');
        statusDiv.innerHTML = `
          <div class="flex items-center">
            <svg class="w-6 h-6 mr-3 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.754 1.34-1.22 2.96-2.694 2.195L10 14.103l-4.58-2.488c-1.474-.765-.89-2.835.617-2.835h.001z" clip-rule="evenodd"></path></svg>
            <p class="font-semibold text-yellow-700">Pack Gold Inactivo o no encontrado. Por favor, verifica tu estado.</p>
          </div>
        `;
        document.getElementById('upload-button').disabled = true;
        document.getElementById('ia-button').disabled = true;
        return;
      }

      // Renderizar estado activo
      statusDiv.classList.remove('hidden', 'bg-yellow-100', 'border-yellow-200');
      statusDiv.classList.add('bg-green-50', 'border-green-100');
      statusDiv.innerHTML = `
        <div class="flex items-center mb-3">
            <svg class="w-6 h-6 mr-3 text-green-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
            <p class="font-bold text-green-700">¡Pack Gold Activo! (ID: ${currentUserId})</p>
        </div>
        
        <!-- Barras de progreso -->
        <div class="space-y-3 mt-4">
          <!-- Slots Propios -->
          <div>
            <div class="flex justify-between mb-1 text-xs font-medium text-gray-700">
              <span>Slots Obra Propia:</span>
              <span>${slotsState.slotsPropios.usados}/${slotsState.slotsPropios.maximo} (${slotsState.slotsPropios.disponibles} disponibles)</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div class="slot-bar-propio h-2.5 rounded-full" style="width: ${slotsState.slotsPropios.usados / slotsState.slotsPropios.maximo * 100}%"></div>
            </div>
          </div>
          <!-- Slots IA -->
          <div>
            <div class="flex justify-between mb-1 text-xs font-medium text-gray-700">
              <span>Slots Boceto IA:</span>
              <span>${slotsState.slotsIA.usados}/${slotsState.slotsIA.maximo} (${slotsState.slotsIA.disponibles} disponibles)</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div class="slot-bar-ia h-2.5 rounded-full" style="width: ${slotsState.slotsIA.usados / slotsState.slotsIA.maximo * 100}%"></div>
            </div>
          </div>
        </div>
      `;
      
      // Actualizar contadores específicos
      document.getElementById('slots-propio-disp').textContent = slotsState.slotsPropios.disponibles;
      document.getElementById('slots-ia-disp').textContent = slotsState.slotsIA.disponibles;
      
      // Habilitar/deshabilitar botones según disponibilidad
      const uploadButton = document.getElementById('upload-button');
      uploadButton.disabled = slotsState.slotsPropios.disponibles <= 0;
      if (uploadButton.disabled) uploadButton.textContent = 'Slots propios agotados';
      else uploadButton.textContent = 'Subir y Certificar Obra';

      const iaButton = document.getElementById('ia-button');
      iaButton.disabled = slotsState.slotsIA.disponibles <= 0;
      if (iaButton.disabled) iaButton.textContent = 'Slots IA agotados';
      else iaButton.textContent = 'Generar Boceto IA y Consumir Slot';
    }

    /** Llama al backend para obtener el estado de los slots. */
    function checkSlots() {
      google.script.run
        .withSuccessHandler(function(response) {
          slotsState = response;
          renderGeneralStatus();
        })
        .withFailureHandler(function(error) {
          showModal("Error de Conexión", "No se pudo cargar el estado de los slots. Por favor, inténtalo de nuevo.", `Detalle: ${error}`);
        })
        .verificarSlotsDisponibles(currentUserId);
    }

    // =========================================================
    // FLÚJO 3: Subida de Obra Propia
    // =========================================================

    /** Maneja la previsualización del archivo seleccionado */
    document.getElementById('file-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const uploadButton = document.getElementById('upload-button');

      if (!file) {
        document.getElementById('preview-container').classList.add('hidden');
        uploadButton.disabled = true;
        return;
      }

      // Validación básica del lado del cliente
      if (file.size > 5 * 1024 * 1024) { // 5MB
        showModal("Error de Archivo", "El archivo excede el tamaño máximo permitido de 5MB.");
        e.target.value = null; // Limpiar el input
        document.getElementById('preview-container').classList.add('hidden');
        uploadButton.disabled = true;
        return;
      }
      
      // Mostrar previsualización
      const reader = new FileReader();
      reader.onload = function(event) {
        document.getElementById('image-preview').src = event.target.result;
        document.getElementById('preview-container').classList.remove('hidden');
      };
      reader.readAsDataURL(file);

      // Si hay slots disponibles, habilitar el botón
      if (slotsState && slotsState.slotsPropios.disponibles > 0) {
        uploadButton.disabled = false;
      }
    });

    /** Función principal para subir la obra propia */
    function handleUploadOwnWork() {
      const fileInput = document.getElementById('file-input');
      const file = fileInput.files[0];
      
      if (!file) {
        showModal("Advertencia", "Por favor, selecciona un archivo para subir.");
        return;
      }

      setButtonLoading('upload-button', true, 'Subir y Certificar Obra');

      try {
        // Usar FileReader para obtener el Blob del archivo
        const reader = new FileReader();
        reader.onload = function(event) {
          // El resultado del reader.readAsArrayBuffer es un ArrayBuffer que se pasa al backend
          // Google Apps Script lo convierte internamente a un Blob para su manejo.
          const fileBlob = event.target.result; 

          // Llamada al backend de Apps Script
          google.script.run
            .withSuccessHandler(function(result) {
              setButtonLoading('upload-button', false, 'Subir y Certificar Obra');
              showModal(
                "¡Obra Certificada!", 
                result.message,
                `<strong>ID de Certificación:</strong> ${result.certificateId}`
              );
              // Limpiar y actualizar UI
              fileInput.value = null;
              document.getElementById('preview-container').classList.add('hidden');
              checkSlots(); // Recargar el estado de los slots
            })
            .withFailureHandler(function(error) {
              setButtonLoading('upload-button', false, 'Subir y Certificar Obra');
              showModal("Error al Certificar", "Ocurrió un error durante la certificación de la obra.", `Detalle: ${error}`);
            })
            // Se envía el blob (ArrayBuffer) y el userId al backend
            .subirObraPropia(fileBlob, currentUserId);
        };
        // Leer el archivo como ArrayBuffer para asegurar que el backend lo pueda manejar como Blob
        reader.readAsArrayBuffer(file); 

      } catch (e) {
        setButtonLoading('upload-button', false, 'Subir y Certificar Obra');
        showModal("Error Crítico", "Hubo un error al procesar el archivo en el navegador.", `Detalle: ${e.message}`);
      }
    }


    // =========================================================
    // FLÚJO 4: Generación de Boceto IA
    // =========================================================

    /** Función principal para generar el boceto IA */
    function handleGenerateIA() {
      const promptInput = document.getElementById('ia-prompt');
      const prompt = promptInput.value.trim();

      if (!prompt) {
        showModal("Advertencia", "Por favor, ingresa una descripción para el boceto IA.");
        return;
      }
      
      const iaButton = document.getElementById('ia-button');
      setButtonLoading('ia-button', true, 'Generar Boceto IA y Consumir Slot');
      
      // Ocultar resultados anteriores
      document.getElementById('ia-result-container').classList.add('hidden');

      // Llamada al backend de Apps Script para la generación IA
      google.script.run
        .withSuccessHandler(function(result) {
          setButtonLoading('ia-button', false, 'Generar Boceto IA y Consumir Slot');
          
          if (result.status === "SUCCESS") {
            // Mostrar resultado de la IA
            document.getElementById('ia-message').textContent = result.message;
            document.getElementById('ia-image-preview').src = result.url;
            document.getElementById('ia-result-container').classList.remove('hidden');

            // Mostrar modal de éxito
            showModal("¡Boceto IA Generado!", result.message, `
              <p><strong>URL del Boceto:</strong> <a href="${result.url}" target="_blank" class="text-red-500 hover:underline">Ver Imagen</a></p>
              <p class="mt-2 text-xs text-gray-500">Nota: Esta es una URL de placeholder. En producción se mostraría la imagen real.</p>
            `);
            
            checkSlots(); // Recargar el estado de los slots
          } else {
            // Manejar error lógico del backend
            showModal("Error de Generación", result.message);
          }
        })
        .withFailureHandler(function(error) {
          setButtonLoading('ia-button', false, 'Generar Boceto IA y Consumir Slot');
          showModal("Error del Servidor", "No se pudo completar la solicitud de generación IA.", `Detalle: ${error}`);
        })
        .activarBocetoIA(prompt, currentUserId);
    }

    // =========================================================
    // INICIALIZACIÓN
    // =========================================================
    
    // Ejecutar al cargar la página para obtener el estado de los slots
    window.onload = function() {
      checkSlots();
    };

  </script>
</body>
</html>
