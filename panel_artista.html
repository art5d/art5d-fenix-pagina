<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ART5D Portal Híbrido: Gestión de Galería GOLD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; }
        .card { background-color: #161b22; border-radius: 16px; border: 1px solid #2f363d; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4); }
        .slot-display { padding: 10px 15px; border-radius: 10px; font-weight: 700; text-align: center; }
        .own-slots { background: linear-gradient(135deg, #374151, #1f2937); color: #9ca3af; } /* Gris Oscuro */
        .ia-slots { background: linear-gradient(135deg, #5b21b6, #4c1d95); color: #e9d5ff; } /* Violeta Intenso */
        .btn-action { transition: all 0.2s; }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(139, 92, 246, 0.6); }
        .progress-bar-own::-webkit-progress-value { background: #10b981; } /* Esmeralda */
        .progress-bar-ia::-webkit-progress-value { background: #f97316; } /* Naranja */
        .progress-bar-own { accent-color: #10b981; }
        .progress-bar-ia { accent-color: #f97316; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse-dot { animation: pulse-dot 1s infinite; }
        .avatar { background-image: url('https://placehold.co/128x128/3b82f6/ffffff?text=AVATAR'); } /* Placeholder de Avatar */
    </style>
</head>
<body class="p-4 sm:p-10 text-white min-h-screen">

    <div class="max-w-6xl mx-auto" id="app-container">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-indigo-500">
                ART5D: Portal Híbrido de Galería VR
            </h1>
            <p class="text-gray-400 mt-3 text-xl">Gestión de tu Pack GOLD: 10 Propios + 5 Bocetos IA</p>
        </header>

        <!-- Bloque Principal de la Aplicación -->
        <div id="main-content">
            <!-- Sección de Perfil y Acceso Rápido -->
            <div class="card p-6 mb-8 flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <div class="w-16 h-16 rounded-full bg-blue-500 flex items-center justify-center text-3xl font-bold shadow-lg avatar">
                        <i class="fas fa-user-astronaut"></i>
                    </div>
                    <div>
                        <p class="text-xl font-bold text-teal-400">Bienvenido, <span id="user-uid-short" class="text-white">Artista</span></p>
                        <p class="text-sm text-gray-500">Estado del Pack: <span id="pack-status" class="text-green-400">ACTIVO (GOLD)</span></p>
                    </div>
                </div>
                
                <!-- Acceso a Galería VR -->
                <button onclick="simulateVRLink()" class="btn-action bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg shadow-blue-500/50 flex items-center space-x-2">
                    <i class="fas fa-vr-cardboard"></i>
                    <span>Acceder a Galería VR (ART5D)</span>
                </button>
            </div>


            <!-- Sección de Estado de Slots (Dinámico) -->
            <div id="slot-status-section" class="card p-6 mb-10 hidden">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-3 text-gray-300">
                    <i class="fas fa-chart-bar text-teal-400 mr-2"></i> Capacidad de Galería Híbrida
                </h2>
                
                <div id="slot-info" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Slots Propios -->
                    <div>
                        <div class="own-slots slot-display mb-3 flex justify-between items-center">
                            <span>SLOTS PROPIOS (MAX 10)</span>
                            <i class="fas fa-palette text-xl"></i>
                        </div>
                        <div class="flex justify-between items-center text-xl">
                            <span class="text-gray-400">Usados: <span id="own-used" class="font-bold text-white">0</span></span>
                            <span class="text-green-400">Disponibles: <span id="own-available" class="font-extrabold text-3xl">10</span></span>
                        </div>
                        <progress id="own-progress" class="w-full h-3 rounded-full mt-3 progress-bar-own" max="10" value="0"></progress>
                    </div>

                    <!-- Slots IA -->
                    <div>
                        <div class="ia-slots slot-display mb-3 flex justify-between items-center">
                            <span>SLOTS BOCETOS IA (MAX 5)</span>
                            <i class="fas fa-robot text-xl"></i>
                        </div>
                        <div class="flex justify-between items-center text-xl">
                            <span class="text-gray-400">Usados: <span id="ia-used" class="font-bold text-white">0</span></span>
                            <span class="text-green-400">Disponibles: <span id="ia-available" class="font-extrabold text-3xl">5</span></span>
                        </div>
                        <progress id="ia-progress" class="w-full h-3 rounded-full mt-3 progress-bar-ia" max="5" value="0"></progress>
                    </div>
                </div>
            </div>

            <!-- Sección de Acciones -->
            <div id="actions-section" class="grid grid-cols-1 lg:grid-cols-2 gap-8 hidden">
                
                <!-- Acción 1: Subir Obra Propia -->
                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-teal-400 mb-4 flex items-center">
                        <i class="fas fa-upload mr-3"></i> Cargar Obra Propia
                    </h3>
                    <p class="text-gray-400 mb-4">Sube tu obra para certificación y exposición en la Galería RV.</p>
                    
                    <input type="file" id="own-file-input" accept="image/jpeg,image/png" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-3 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-bold
                        file:bg-teal-600 file:text-white
                        hover:file:bg-teal-700 mb-4 cursor-pointer"
                    />
                    
                    <button onclick="handleUploadOwnWork()" id="btn-upload-own" class="btn-action w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-teal-500/50" disabled>
                        Subir y Certificar Obra Propia
                    </button>
                    <p id="upload-status" class="text-sm mt-3 text-center text-gray-500"></p>
                </div>

                <!-- Acción 2: Solicitar Boceto IA -->
                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-violet-400 mb-4 flex items-center">
                        <i class="fas fa-magic mr-3"></i> Solicitar Boceto IA Certificado
                    </h3>
                    <p class="text-gray-400 mb-4">Genera un boceto inicial de IA. Tienes 5 slots para esta función.</p>
                    
                    <textarea id="ia-prompt-input" rows="3" placeholder="Describe el boceto (ej: Retrato cyberpunk de un guerrero, estilo óleo)." 
                        class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-violet-500 focus:border-violet-500 mb-4 text-white resize-none"
                        maxlength="250"></textarea>

                    <button onclick="handleRequestIABoceto()" id="btn-request-ia" class="btn-action w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-violet-500/50" disabled>
                        Generar Boceto IA Certificado
                    </button>
                    <p id="ia-status" class="text-sm mt-3 text-center text-gray-500"></p>
                    
                    <!-- Contenedor para la imagen generada -->
                    <div id="ia-image-container" class="mt-4 p-4 border border-gray-700 rounded-xl hidden">
                        <h4 class="text-sm font-semibold mb-3 text-gray-300 flex items-center">
                            <i class="fas fa-file-image mr-2 text-orange-400"></i> Último Boceto Generado (Certificado)
                        </h4>
                        <img id="ia-generated-image" src="" alt="Boceto Generado por IA" class="w-full h-auto rounded-lg border border-orange-500 shadow-xl" />
                        <p id="ia-image-prompt" class="text-xs text-gray-500 mt-2 italic truncate"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Indicadores de estado y debug -->
        <div class="mt-12 pt-6 border-t border-gray-700 text-center text-xs text-gray-500">
             <div id="auth-status" class="text-sm mb-2 font-mono text-white">
                <span id="loading-indicator-small" class="inline-block w-3 h-3 bg-red-500 rounded-full pulse-dot mr-2"></span>
                <span id="status-text">Iniciando sesión segura...</span>
            </div>
            Tu ID de Sesión (Necesario para Firestore): <span id="user-uid" class="font-mono text-gray-300 select-all">Cargando...</span>
        </div>
    </div>

    <!-- Mensaje Modal de Simulación VR -->
    <div id="vr-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="card p-8 max-w-md w-full text-center">
            <i class="fas fa-cubes text-6xl text-blue-400 mb-4"></i>
            <h3 class="text-3xl font-bold mb-3 text-white">¡Conexión VR Establecida!</h3>
            <p class="text-gray-400 mb-6">
                En la plataforma ART5D, serías redirigido a la Galería RV (Powered by A-Frame/Three.js).
                Tu última obra/boceto estará visible en tu espacio designado.
            </p>
            <button onclick="document.getElementById('vr-modal').classList.add('hidden')" class="btn-action bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl">
                Cerrar Simulación
            </button>
        </div>
    </div>
    
    <!-- Script de Funcionalidad Híbrida (Firebase + Netlify Function) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, onSnapshot, runTransaction, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuración de Firebase
        setLogLevel('error');

        // Variables Globales (Disponibles en el entorno Canvas/Netlify)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-art5d-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, currentUserId = null;

        // Constantes del Pack GOLD 
        const MAX_SLOTS_OWN = 10;
        const MAX_SLOTS_IA = 5;
        const COLLECTION_USERS = `artifacts/${appId}/users`;
        
        // Referencias a elementos del DOM
        const uidSpan = document.getElementById('user-uid');
        const uidShortSpan = document.getElementById('user-uid-short');
        const loadingDot = document.getElementById('loading-indicator-small');
        const statusText = document.getElementById('status-text');
        const slotStatusSection = document.getElementById('slot-status-section');
        const actionsSection = document.getElementById('actions-section');
        const mainContent = document.getElementById('main-content');
        const iaImagePrompt = document.getElementById('ia-image-prompt');


        // =========================================================
        // 1. INICIALIZACIÓN Y AUTENTICACIÓN
        // =========================================================

        const displayStatus = (text, colorClass) => {
            statusText.textContent = text;
            loadingDot.classList.remove('bg-red-500', 'bg-yellow-500', 'bg-green-500');
            loadingDot.classList.add(colorClass);
        };
        
        const setupFirebase = async () => {
            if (!firebaseConfig) {
                displayStatus("Fallo de Configuración: Firebase no inicializado.", 'bg-red-500');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                displayStatus("Conectando...", 'bg-yellow-500');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        uidSpan.textContent = currentUserId;
                        uidShortSpan.textContent = "Artista " + currentUserId.substring(0, 4) + "...";
                        displayStatus("Autenticado. Cargando datos...", 'bg-yellow-500');
                        
                        await loadUserData(currentUserId);
                        
                        // Una vez listos, mostramos la UI principal
                        mainContent.classList.remove('hidden');
                        slotStatusSection.classList.remove('hidden');
                        actionsSection.classList.remove('hidden');
                        displayStatus("ART5D Listo.", 'bg-green-500');

                    } else {
                        // Intentar inicio de sesión
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // En Netlify, si el token no está, usamos Anónimo.
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Error en la inicialización o autenticación de Firebase:", error);
                displayStatus(`ERROR: ${error.message.substring(0, 50)}...`, 'bg-red-500');
            }
        };

        // =========================================================
        // 2. LÓGICA DE FIRESTORE (Lectura en Tiempo Real)
        // =========================================================

        const loadUserData = (userId) => {
            const userDocRef = doc(db, COLLECTION_USERS, userId);

            onSnapshot(userDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const userData = docSnapshot.data();
                    updateSlotDisplay(userData);
                } else {
                    // Inicializar el documento (Asumimos Pack GOLD por defecto)
                    const initialData = {
                        slotsPropios: MAX_SLOTS_OWN,
                        slotsIA: MAX_SLOTS_IA,
                        lastGeneratedIA: null 
                    };
                    // Usar setDoc para crear el documento con los valores iniciales
                    runTransaction(db, async (transaction) => {
                        transaction.set(userDocRef, initialData);
                    }).catch(error => {
                        console.error("Error al inicializar documento:", error);
                        // Mostrar error específico si es necesario.
                    });
                }
            }, (error) => {
                console.error("Error en onSnapshot:", error);
                displayStatus(`Error de Firestore: ${error.message.substring(0, 50)}...`, 'bg-red-500');
            });
        };

        // =========================================================
        // 3. ACTUALIZACIÓN DE LA UI
        // =========================================================

        const updateSlotDisplay = (userData) => {
            const currentOwn = userData.slotsPropios || 0;
            const currentIA = userData.slotsIA || 0;

            const ownUsed = MAX_SLOTS_OWN - currentOwn;
            const iaUsed = MAX_SLOTS_IA - currentIA;

            // 1. Slots Propios
            document.getElementById('own-used').textContent = ownUsed;
            document.getElementById('own-available').textContent = currentOwn;
            document.getElementById('own-progress').setAttribute('value', ownUsed);

            // 2. Slots IA
            document.getElementById('ia-used').textContent = iaUsed;
            document.getElementById('ia-available').textContent = currentIA;
            document.getElementById('ia-progress').setAttribute('value', iaUsed);

            // 3. Habilitar/Deshabilitar botones
            const btnUploadOwn = document.getElementById('btn-upload-own');
            const btnRequestIA = document.getElementById('btn-request-ia');
            const fileInputOwn = document.getElementById('own-file-input');
            const promptInputIA = document.getElementById('ia-prompt-input');

            btnUploadOwn.disabled = currentOwn <= 0;
            fileInputOwn.disabled = currentOwn <= 0;
            btnUploadOwn.textContent = currentOwn <= 0 ? "Slots Propios Agotados" : "Subir y Certificar Obra Propia";

            btnRequestIA.disabled = currentIA <= 0;
            promptInputIA.disabled = currentIA <= 0;
            btnRequestIA.textContent = currentIA <= 0 ? "Slots IA Agotados" : "Generar Boceto IA Certificado";

            // 4. Mostrar última imagen si existe
            const lastGeneratedIA = userData.lastGeneratedIA;
            const iaImageContainer = document.getElementById('ia-image-container');
            const iaGeneratedImage = document.getElementById('ia-generated-image');

            if (lastGeneratedIA && lastGeneratedIA.url) {
                iaGeneratedImage.src = lastGeneratedIA.url;
                iaImagePrompt.textContent = `Prompt: ${lastGeneratedIA.prompt}`;
                iaImageContainer.classList.remove('hidden');
            } else {
                 iaImageContainer.classList.add('hidden');
            }
        };

        // =========================================================
        // 4. LÓGICA DE ACCIONES
        // =========================================================

        window.simulateVRLink = () => {
             document.getElementById('vr-modal').classList.remove('hidden');
        }

        window.handleUploadOwnWork = () => {
            const uploadStatus = document.getElementById('upload-status');
            const fileInput = document.getElementById('own-file-input');
            const file = fileInput.files[0];
            const btnUploadOwn = document.getElementById('btn-upload-own');
            const originalText = btnUploadOwn.textContent;

            if (!file) {
                uploadStatus.textContent = "Por favor, selecciona un archivo (JPEG/PNG).";
                return;
            }
            
            // 1. Bloquear UI
            btnUploadOwn.disabled = true;
            uploadStatus.textContent = `Subiendo ${file.name} y validando...`;
            btnUploadOwn.textContent = "Procesando Certificación...";

            // Simulación de proceso de certificación y descuento de slot
            setTimeout(async () => {
                try {
                     await runTransaction(db, async (transaction) => {
                        const userDocRef = doc(db, COLLECTION_USERS, currentUserId);
                        const userDoc = await transaction.get(userDocRef);
                        
                        if (!userDoc.exists()) { throw new Error("Documento de usuario no existe."); }
                        
                        const currentSlots = userDoc.data().slotsPropios || 0;
                        if (currentSlots <= 0) { throw new Error("No quedan slots propios disponibles."); }
                        
                        transaction.update(userDocRef, { 
                            slotsPropios: currentSlots - 1
                            // En un entorno real: Añadir referencia al archivo subido en Storage
                        });
                    });

                    uploadStatus.textContent = `¡Obra '${file.name}' certificada y en Galería RV!`;
                    uploadStatus.classList.add('text-green-400');
                    fileInput.value = ''; // Limpiar input

                } catch(error) {
                    uploadStatus.textContent = `ERROR al subir: ${error.message}`;
                    uploadStatus.classList.remove('text-green-400');
                    uploadStatus.classList.add('text-red-400');
                    btnUploadOwn.textContent = originalText; // Restaurar texto si falla el descuento.
                } finally {
                    // La función updateSlotDisplay (onSnapshot) re-habilitará el botón
                }

            }, 3000); // 3 segundos para simular la subida
        };


        window.handleRequestIABoceto = async () => {
            if (!currentUserId) {
                displayStatus("La autenticación aún no está lista. Intente de nuevo.", 'bg-red-500');
                return;
            }

            const iaStatus = document.getElementById('ia-status');
            const prompt = document.getElementById('ia-prompt-input').value.trim();
            const btnRequestIA = document.getElementById('btn-request-ia');
            
            if (prompt.length === 0) {
                iaStatus.textContent = "El prompt no puede estar vacío.";
                return;
            }
            
            // 1. Bloquear UI
            btnRequestIA.disabled = true;
            const originalText = btnRequestIA.textContent;
            btnRequestIA.textContent = "Generando Boceto... Esto podría tardar 30 segundos.";
            iaStatus.textContent = `Iniciando generación para: "${prompt}"...`;
            iaStatus.classList.add('text-yellow-400');
            iaStatus.classList.remove('text-red-400', 'text-green-400');

            const FUNCTION_URL = "/.netlify/functions/generar-boceto"; 
            
            try {
                // Paso A: Llamar a la Netlify Function (Servidor Seguro)
                const response = await fetch(FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt }) 
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || "Error desconocido en la Netlify Function.");
                }

                const imageUrl = data.imageUrl; // Imagen en base64

                // Paso B: Ejecutar la transacción de Firestore para descontar el slot y guardar la URL
                await runTransaction(db, async (transaction) => {
                    const userDocRef = doc(db, COLLECTION_USERS, currentUserId);
                    const userDoc = await transaction.get(userDocRef);
                    
                    if (!userDoc.exists()) { throw new Error("Documento de usuario no existe."); }
                    
                    const currentSlots = userDoc.data().slotsIA || 0;
                    if (currentSlots <= 0) { throw new Error("No quedan slots IA disponibles."); }
                    
                    const newSlots = currentSlots - 1;
                    transaction.update(userDocRef, { 
                        slotsIA: newSlots,
                        lastGeneratedIA: {
                            url: imageUrl,
                            prompt: prompt,
                            timestamp: new Date().toISOString()
                        }
                    });
                });

                // Si todo es exitoso
                iaStatus.textContent = `¡Boceto IA Generado, Slot Descontado y Certificado!`;
                iaStatus.classList.add('text-green-400');
                iaStatus.classList.remove('text-yellow-400');

            } catch (error) {
                console.error("Error en la generación de boceto:", error);
                iaStatus.textContent = `ERROR: Fallo en la IA o Slot: ${error.message}`;
                iaStatus.classList.add('text-red-400');
                iaStatus.classList.remove('text-yellow-400');
            } finally {
                // Restaurar UI - onSnapshot se encarga de re-habilitar el botón
                btnRequestIA.textContent = originalText; 
            }
        };

        // Iniciar la aplicación de Firebase al cargar el script.
        setupFirebase();

    </script>
</body>
</html>
