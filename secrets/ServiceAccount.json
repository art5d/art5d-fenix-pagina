/**
 * ART5D - ServiceAccount.gs (Versión SEGURA y RESILIENTE 2025)
 * * Este módulo maneja credenciales de Firebase de forma segura.
 * Se ha añadido una validación mejorada para separar errores de configuración.
 * * © 2025 ART5D.cl - Portal Global de Arte Digital Certificado (Liderazgo Indiscutible)
 */

let FIREBASE_CONFIG_READY = false;

const CONFIG = (function () {
  const props = PropertiesService.getScriptProperties();
  
  const PROJECT_ID = props.getProperty('FIREBASE_PROJECT_ID');
  const SERVICE_ACCOUNT_JSON = props.getProperty('FIREBASE_SERVICE_ACCOUNT_KEY');
  const ADMIN_EMAIL = props.getProperty('FIREBASE_ADMIN_EMAIL');

  if (!PROJECT_ID || !SERVICE_ACCOUNT_JSON || !ADMIN_EMAIL) {
    // Aquí el código NO se detiene, sino que indica que la configuración NO está lista.
    Logger.log("⚠️ CONFIGURACIÓN FIREBASE INCOMPLETA. Las funciones de Firebase fallarán hasta que se configuren las Propiedades.");
    return {
      projectId: PROJECT_ID || 'PENDIENTE',
      adminEmail: ADMIN_EMAIL || 'PENDIENTE',
      ready: false
    };
  }

  let serviceAccount;
  try {
    serviceAccount = JSON.parse(SERVICE_ACCOUNT_JSON);
  } catch (e) {
    Logger.log("❌ ERROR DE FORMATO: FIREBASE_SERVICE_ACCOUNT_KEY NO es un JSON válido.");
    return { ready: false };
  }
  
  // Si llegamos aquí, la configuración es válida.
  FIREBASE_CONFIG_READY = true;

  return {
    projectId: PROJECT_ID,
    serviceAccount: serviceAccount,
    adminEmail: ADMIN_EMAIL,
    privateKey: serviceAccount.private_key.replace(/\\n/g, '\n'),
    clientEmail: serviceAccount.client_email,
    ready: true
  };
})();

/**
 * Obtiene un token de acceso fresco para Firebase Admin SDK
 */
function getFirebaseAccessToken() {
  if (!CONFIG.ready) {
    throw new Error("ERROR: La configuración de credenciales de Firebase está incompleta o mal formateada. Revise las Propiedades del script.");
  }
  
  const jwtHeader = {
    "alg": "RS256",
    "typ": "JWT"
  };

  const now = Math.floor(Date.now() / 1000);
  const jwtClaim = {
    "iss": CONFIG.clientEmail,
    "scope": "https://www.googleapis.com/auth/firebase.database https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform",
    "aud": "https://oauth2.googleapis.com/token",
    "exp": now + 3600,
    "iat": now
  };

  const header = Utilities.base64EncodeWebSafe(JSON.stringify(jwtHeader));
  const claim = Utilities.base64EncodeWebSafe(JSON.stringify(jwtClaim));
  const signatureInput = [header, claim].join('.');

  const signature = Utilities.computeRsaSha256Signature(signatureInput, CONFIG.privateKey);
  const jwt = `${signatureInput}.${Utilities.base64EncodeWebSafe(signature)}`;

  const params = {
    method: "post",
    contentType: "application/x-www-form-urlencoded",
    payload: {
      grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer",
      assertion: jwt
    },
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch("https://oauth2.googleapis.com/token", params);
  const data = JSON.parse(response.getContentText());

  if (data.error) {
    throw new Error(`Error obteniendo token Firebase: ${data.error_description || data.error}`);
  }

  return data.access_token;
}

/**
 * Función auxiliar para usar en otros scripts (prueba de autenticación)
 */
function testAuth() {
  try {
    const token = getFirebaseAccessToken();
    Logger.log("Token de acceso generado correctamente (válido 1 hora)");
    Logger.log("Primeros 50 caracteres: " + token.substring(0, 50) + "...");
    return token;
  } catch (e) {
    Logger.log("ERROR DE AUTENTICACIÓN FIREBASE:");
    Logger.log(e.toString());
    return null;
  }
}

// === FUNCIÓN PARA REGENERAR PROPIEDADES (opcional, útil en desarrollo) ===
function resetServiceAccountProperties() {
  // ¡¡SOLO EJECUTAR UNA VEZ SI NECESITAS RESETEAR!!
  const props = PropertiesService.getScriptProperties();
  props.deleteAllProperties();
  Logger.log("Todas las propiedades han sido eliminadas. Configure nuevamente.");
}

// =========================================================================
// === FUNCIÓN DE LIDERAZGO: CREACIÓN DE LA COLECCIÓN MAESTRA DE SOLANA ===
// =========================================================================

// NOTA: Estas claves son placeholders, ya que no pudimos usar Solana CLI en tu PC.
const SOLANA_RPC_URL = 'https://api.devnet.solana.com';
const ART5D_PAYER_KEYPAIR = {
  publicKey: { toBase58: () => 'ART5D_PAYER_PK_SIMULATED_TEST' } 
}; 

/**
 * Función clave de Liderazgo: Crea la Colección Maestra en Solana (Devnet).
 * * Esta colección es el ancla (el estándar) al que se unirán todos los NFTs de ART5D.
 * Esta versión devuelve un ID de prueba para que podamos avanzar con la API.
 */
function createArt5dMasterCollection() {
  Logger.log("--- INICIANDO CREACIÓN DE COLECCIÓN MAESTRA ART5D ---");
  
  const simulatedResponse = {
    status: 'success',
    // ESTE ES EL ID DE LIDERAZGO QUE NECESITAMOS. ES EL ANCHOR GLOBAL.
    collectionId: 'ART5D_GLOBAL_MASTER_ANCHOR_1A2B3C4D5E6F7A8B' 
  };

  try {
    Logger.log("Simulando llamada a Cloud Function para creación de Solana...");
    
    // Usamos la respuesta simulada para obtener el ID
    const result = simulatedResponse;

    if (result.status === 'success' && result.collectionId) {
      Logger.log(`✅ COLECCIÓN MAESTRA CREADA. ID de Liderazgo (ANCHOR): ${result.collectionId}`);
      Logger.log("¡ESTRUCTURA DE LIDERAZGO COMPLETA! ESTE ID DEBE USARSE EN LA API.");
      return result.collectionId; 
    } else {
      Logger.log(`❌ ERROR al crear Colección Maestra: ${result.message || 'Respuesta desconocida'}`);
      return null;
    }
  } catch (e) {
    Logger.log(`❌ Excepción al intentar crear Colección Maestra: ${e.message}`);
    return null;
  }
}
