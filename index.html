<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación Nueva desde Cero</title>
    <!-- Carga de Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente por defecto para mejor legibilidad */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4">
    <div id="app-container" class="w-full max-w-4xl bg-white shadow-xl rounded-xl p-6 md:p-8 mt-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">¡Comenzando de Cero!</h1>
        <p class="text-center text-gray-600 mb-8">La aplicación está lista para recibir tu nuevo código.</p>
        
        <!-- Contenedor principal donde construirás tu UI -->
        <div id="main-content" class="min-h-64 border-2 border-dashed border-indigo-300 rounded-lg p-4 flex items-center justify-center">
            <p id="auth-status" class="text-indigo-500 font-semibold">Cargando Firebase...</p>
        </div>

        <!-- Mensajes del sistema (para alertas personalizadas, no usamos alert()) -->
        <div id="message-box" class="mt-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg hidden" role="alert"></div>

    </div>

    <!-- Script de configuración de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globales que serán inicializadas
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // ID de usuario por defecto

        // Constantes del entorno
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const authStatusElement = document.getElementById('auth-status');
        const messageBox = document.getElementById('message-box');
        
        // Función para mostrar mensajes de estado
        function displayMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = "mt-4 p-3 rounded-lg block";
            if (isError) {
                messageBox.classList.add('bg-red-100', 'text-red-800');
                messageBox.classList.remove('bg-yellow-100', 'text-yellow-800');
            } else {
                messageBox.classList.add('bg-yellow-100', 'text-yellow-800');
                messageBox.classList.remove('bg-red-100', 'text-red-800');
            }
        }

        // Inicializar y autenticar
        async function initializeAppAndAuth() {
            if (!firebaseConfig) {
                authStatusElement.textContent = "Error: Configuración de Firebase no disponible.";
                return;
            }

            try {
                // Habilitar logging de Firebase para debug
                setLogLevel('debug');
                
                // 1. Inicializar Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                authStatusElement.textContent = "Inicializando autenticación...";

                // 2. Intentar autenticación con el token proporcionado
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Si no hay token, usar autenticación anónima
                    await signInAnonymously(auth);
                }

                // 3. Listener de estado de autenticación (siempre útil)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.textContent = `Autenticado. User ID: ${userId}`;
                        authStatusElement.classList.remove('text-indigo-500');
                        authStatusElement.classList.add('text-green-500');
                        console.log("Firebase Auth listo. User ID:", userId);

                        // --- COMIENZA AQUÍ EL CÓDIGO DE TU APLICACIÓN ---
                        // Una vez que la autenticación es exitosa, puedes llamar a tus funciones de inicialización
                        // Por ejemplo: initAppLogic(db, userId);

                    } else {
                        userId = 'anonymous';
                        authStatusElement.textContent = "Sesión no iniciada (Anónima).";
                        console.log("Sesión no iniciada (Anónima).");
                        authStatusElement.classList.remove('text-green-500');
                        authStatusElement.classList.add('text-red-500');
                    }
                });

            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                authStatusElement.textContent = `Error de Firebase: ${error.message}`;
                authStatusElement.classList.add('text-red-500');
            }
        }

        initializeAppAndAuth();

        // ----------------------------------------------------
        // EJEMPLO DE CÓMO OBTENER UNA RUTA DE COLECCIÓN
        // ----------------------------------------------------

        // Colección privada (para el usuario actual)
        function getPrivateCollectionRef(collectionName) {
            if (!db || !userId) {
                console.error("DB o User ID no disponibles para colección privada.");
                return null;
            }
            return collection(db, `/artifacts/${appId}/users/${userId}/${collectionName}`);
        }

        // Colección pública (compartida entre todos los usuarios)
        function getPublicCollectionRef(collectionName) {
            if (!db) {
                console.error("DB no disponible para colección pública.");
                return null;
            }
            return collection(db, `/artifacts/${appId}/public/data/${collectionName}`);
        }

        // Puedes exportar o definir funciones globales aquí si lo necesitas para interactuar con la consola
        window.getPublicCollectionRef = getPublicCollectionRef;
        window.getPrivateCollectionRef = getPrivateCollectionRef;
        window.displayMessage = displayMessage; // Permite usar displayMessage en tu lógica
    </script>
</body>
</html>
